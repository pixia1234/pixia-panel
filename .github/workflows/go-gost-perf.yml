name: go-gost-perf

on:
  push:
    branches:
      - dev
    paths:
      - go-gost/**
      - .github/workflows/go-gost-perf.yml
  pull_request:
    branches:
      - main
    paths:
      - go-gost/**
      - .github/workflows/go-gost-perf.yml
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gost-forward-tunnel-perf:
    name: gost-forward-tunnel-perf
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go-gost/go.mod
          cache: true
          cache-dependency-path: go-gost/go.sum

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y iperf3 jq openssl

      - name: Build project gost binary
        run: |
          set -euo pipefail
          cd go-gost
          go build -trimpath -ldflags "-s -w" -o "$RUNNER_TEMP/gost-under-test" .
          "$RUNNER_TEMP/gost-under-test" -V
          sha256sum "$RUNNER_TEMP/gost-under-test" | tee "$RUNNER_TEMP/gost-under-test.sha256"

      - name: Run forward and tunnel benchmarks
        shell: bash
        run: |
          set -euo pipefail

          BIN="$RUNNER_TEMP/gost-under-test"
          OUT_DIR="perf-artifacts"
          mkdir -p "$OUT_DIR"

          cp "$RUNNER_TEMP/gost-under-test.sha256" "$OUT_DIR/gost-under-test.sha256"

          RESULTS_CSV="$OUT_DIR/results.csv"
          echo "scenario,transport,bps,loss,error" > "$RESULTS_CSV"

          cat > config.json <<'JSON'
          {
            "addr": "http://127.0.0.1:65535",
            "secret": "perf-ci-secret",
            "http": 0,
            "tls": 0,
            "socks": 0
          }
          JSON

          openssl req -x509 -newkey rsa:2048 -sha256 -days 1 -nodes \
            -keyout "$OUT_DIR/key.pem" -out "$OUT_DIR/cert.pem" \
            -subj '/CN=localhost' >/dev/null 2>&1

          cleanup_pid() {
            local pid="${1:-}"
            if [[ -n "${pid}" ]]; then
              kill "$pid" >/dev/null 2>&1 || true
              wait "$pid" 2>/dev/null || true
            fi
          }

          collect_result() {
            local scenario="$1"
            local transport="$2"
            local json_file="$3"

            local bps
            local loss
            local error

            bps=$(jq -r '.end.sum_received.bits_per_second // .end.sum_sent.bits_per_second // .end.sum.bits_per_second // 0' "$json_file")
            loss=$(jq -r '.end.sum.lost_percent // 0' "$json_file")
            error=$(jq -r '.error // ""' "$json_file")

            error=${error//,/;}
            echo "${scenario},${transport},${bps},${loss},${error}" >> "$RESULTS_CSV"

            if [[ -n "$error" ]]; then
              echo "[FAIL] ${scenario}/${transport}: ${error}"
              return 1
            fi

            echo "[OK] ${scenario}/${transport}: ${bps} bps"
          }

          run_port_forward_tcp() {
            local entry_port="23000"
            local json_file="$OUT_DIR/port-forward-tcp.json"

            "$BIN" -L "tcp://127.0.0.1:${entry_port}/127.0.0.1:5201?enableStats=true" >"$OUT_DIR/gost-port-forward.log" 2>&1 &
            local gost_pid=$!
            sleep 2

            iperf3 -c 127.0.0.1 -p "$entry_port" -t 15 -P 4 -J >"$json_file" || true

            cleanup_pid "$gost_pid"
            collect_result "port-forward" "tcp" "$json_file"
          }

          run_tunnel_case() {
            local proto="$1"
            local relay_port="$2"
            local entry_port="$3"
            local client_query="${4:-}"
            local server_query="${5:-}"

            local json_file="$OUT_DIR/tunnel-${proto}.json"
            local server_log="$OUT_DIR/gost-tunnel-server-${proto}.log"
            local client_log="$OUT_DIR/gost-tunnel-client-${proto}.log"

            "$BIN" -L "relay+${proto}://127.0.0.1:${relay_port}${server_query}" >"$server_log" 2>&1 &
            local server_pid=$!
            sleep 2

            "$BIN" -L "tcp://127.0.0.1:${entry_port}/127.0.0.1:5201?enableStats=true" -F "relay+${proto}://127.0.0.1:${relay_port}${client_query}" >"$client_log" 2>&1 &
            local client_pid=$!
            sleep 2

            iperf3 -c 127.0.0.1 -p "$entry_port" -t 15 -P 4 -J >"$json_file" || true

            cleanup_pid "$client_pid"
            cleanup_pid "$server_pid"
            collect_result "tunnel-forward" "$proto" "$json_file"
          }

          iperf3 -s -p 5201 >"$OUT_DIR/iperf-target.log" 2>&1 &
          TARGET_PID=$!

          EXIT_CODE=0
          run_port_forward_tcp || EXIT_CODE=1
          run_tunnel_case "tcp" 24001 23001 "?enableStats=true" "?enableStats=true" || EXIT_CODE=1
          run_tunnel_case "mtcp" 24002 23002 "?enableStats=true" "?enableStats=true" || EXIT_CODE=1
          run_tunnel_case "tls" 24003 23003 "?secure=false&enableStats=true" "?certFile=${OUT_DIR}/cert.pem&keyFile=${OUT_DIR}/key.pem&enableStats=true" || EXIT_CODE=1
          run_tunnel_case "wss" 24004 23004 "?secure=false&enableStats=true" "?certFile=${OUT_DIR}/cert.pem&keyFile=${OUT_DIR}/key.pem&enableStats=true" || EXIT_CODE=1

          cleanup_pid "$TARGET_PID"
          rm -f config.json

          {
            echo "## go-gost forward/tunnel perf (project binary)"
            echo
            echo "- Binary SHA256: $(cat "$OUT_DIR/gost-under-test.sha256")"
            echo
            echo "| Scenario | Transport | Throughput (bps) | Loss (%) | Error |"
            echo "|---|---:|---:|---:|---|"
            awk -F',' 'NR>1 { printf "| %s | %s | %s | %s | %s |\n", $1, $2, $3, $4, ($5==""?"-":$5) }' "$RESULTS_CSV"
          } >> "$GITHUB_STEP_SUMMARY"

          exit "$EXIT_CODE"

      - name: Upload perf artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gost-forward-tunnel-perf-${{ github.sha }}
          path: perf-artifacts
          if-no-files-found: error
